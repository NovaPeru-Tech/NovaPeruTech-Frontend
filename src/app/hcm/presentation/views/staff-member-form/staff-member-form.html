<app-layout-nursing-home>
  <h1 class="title">{{ (isEdit ? 'staff-management.edit.title' : 'staff-management.new.title') | translate }}</h1>

  <div class="form-wrapper">
    @if (store.loading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    @if (store.error()) {
      <div class="error-container">
        <mat-error>{{ store.error() }}</mat-error>
      </div>
    }

    <form [formGroup]="form" (ngSubmit)="submit()" class="staff-form">
      <mat-card class="header-card">
        <div class="form-row">
          <!-- Photo Upload -->
          <div class="image-upload-section">
            <label class="image-label">
              {{ 'staff-management.image' | translate }}
              <span class="required">*</span>
            </label>

            <div class="image-upload-container">
              @if (!imagePreview) {
                <div class="upload-placeholder">
                  <input type="file" #fileInput accept="image/*" (change)="onFileSelected($event)"
                         style="display: none">
                  <button mat-raised-button color="primary" type="button" (click)="fileInput.click()">
                    <mat-icon>add_photo_alternate</mat-icon>
                    {{ 'staff-management.form.select-image' | translate }}
                  </button>
                  <p class="upload-hint">JPG, PNG - {{ 'staff-management.form.max-size' | translate }}</p>
                </div>
              } @else {
                <div class="image-preview-container">
                  <img [src]="imagePreview" alt="Preview" class="image-preview">
                  <button mat-icon-button color="warn" type="button" class="remove-image-btn" (click)="removeImage()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>

            @if (form.get('image')?.touched && form.get('image')!.hasError('required')) {
              <mat-error class="image-error">
                {{ 'staff-management.error.image-required' | translate }}
              </mat-error>
            }
          </div>
          <div class="row">
            <mat-form-field>
              <mat-label>{{ 'staff-management.first-name' | translate }}</mat-label>
              <input matInput formControlName="name" required>
              @if (form.get('name')?.touched && form.get('name')!.hasError('required')) {
                <mat-error>{{ 'staff-management.error.name-required' | translate }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field>
              <mat-label>{{ 'staff-management.last-name' | translate }}</mat-label>
              <input matInput formControlName="lastname" required>
              @if (form.get('lastname')?.touched && form.get('lastname')!.hasError('required')) {
                <mat-error>{{ 'staff-management.error.last-name-required' | translate }}</mat-error>
              }
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'staff-management.state' | translate }}</mat-label>
              <mat-select formControlName="state" required>
                @for (status of stateOptions; track status) {
                  <mat-option [value]="status">{{ status }}</mat-option>
                }
              </mat-select>
              @if (form.get('state')?.touched && form.get('state')!.hasError('required')) {
                <mat-error>{{ 'staff-management.error.state-required' | translate }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      </mat-card>

      <div class="section-divider">
        <mat-icon>person</mat-icon>
        <span>{{ 'staff-management.basic-info' | translate }}</span>
      </div>

      <div class="info-grid">
        <mat-card class="info-card">
          <div class="card-header-custom">
            <div class="icon-wrapper personal">
              <mat-icon>person</mat-icon>
            </div>
            <h3>{{ 'staff-management.personal-info' | translate }}</h3>
          </div>
          <div class="card-body">
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.dni' | translate }}</mat-label>
                <input matInput formControlName="dni" required>
                @if (form.get('dni')?.touched && form.get('dni')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.dni-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <div class="calendar-section">
                <label class="section-label">
                  {{ 'staff-management.birthDate' | translate }}
                  <span class="required">*</span>
                  @if (isEdit) {
                    <span class="readonly-badge">{{ 'staff-management.readonly' | translate }}</span>
                  }
                </label>

                <mat-calendar
                  [selected]="form.value.birthDate"
                  (selectedChange)="onBirthDateSelected($event)"
                  [maxDate]="maxDate"
                  [startAt]="startDate">
                </mat-calendar>

                @if (form.value.birthDate) {
                  <div class="selected-date">
                    <mat-icon>event</mat-icon>
                    <span>{{ form.value.birthDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                }

                @if (form.get('birthDate')?.touched && form.get('birthDate')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.birthDate-required' | translate }}</mat-error>
                }
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.nationality' | translate }}</mat-label>
                <input matInput formControlName="nationality">
                <mat-hint>{{ 'staff-management.form.optional' | translate }}</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </mat-card>

        <mat-card class="info-card">
          <div class="card-header-custom">
            <div class="icon-wrapper contact">
              <mat-icon>contact_phone</mat-icon>
            </div>
            <h3>{{ 'staff-management.contact-info' | translate }}</h3>
          </div>
          <div class="card-body">
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.phone' | translate }}</mat-label>
                <input matInput formControlName="phoneNumber" required>
                @if (form.get('phoneNumber')?.touched && form.get('phoneNumber')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.phoneNumber-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.email' | translate }}</mat-label>
                <input matInput type="email" formControlName="email" required>
                @if (form.get('email')?.touched && form.get('email')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.email-required' | translate }}</mat-error>
                }
                @if (form.get('email')?.touched && form.get('email')!.hasError('email')) {
                  <mat-error>{{ 'staff-management.error.email-invalid' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.address' | translate }}</mat-label>
                <textarea matInput formControlName="address" rows="2" required></textarea>
                @if (form.get('address')?.touched && form.get('address')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.address-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Employment Information Section -->
      <div class="section-divider">
        <mat-icon>work</mat-icon>
        <span>{{ 'staff-management.employment-info' | translate }}</span>
      </div>

      <div class="info-grid">
        <mat-card class="info-card">
          <div class="card-header-custom">
            <div class="icon-wrapper employment">
              <mat-icon>badge</mat-icon>
            </div>
            <h3>{{ 'staff-management.position-contract' | translate }}</h3>
          </div>
          <div class="card-body">
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.position' | translate }}</mat-label>
                <mat-select formControlName="post" required>
                  @for (position of postOptions; track position) {
                    <mat-option [value]="position">{{ position }}</mat-option>
                  }
                </mat-select>
                @if (form.get('post')?.touched && form.get('post')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.post-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.type-of-contract' | translate }}</mat-label>
                <mat-select formControlName="typeOfContract" required>
                  @for (contractType of typeOfContractOptions; track contractType) {
                    <mat-option [value]="contractType">{{ contractType }}</mat-option>
                  }
                </mat-select>
                @if (form.get('typeOfContract')?.touched && form.get('typeOfContract')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.typeOfContract-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.work-shift' | translate }}</mat-label>
                <mat-select formControlName="workShift" required>
                  @for (shift of workShiftOptions; track shift) {
                    <mat-option [value]="shift">{{ shift }}</mat-option>
                  }
                </mat-select>
                @if (form.get('workShift')?.touched && form.get('workShift')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.workShift-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </mat-card>

        <mat-card class="info-card">
          <div class="card-header-custom">
            <div class="icon-wrapper employment">
              <mat-icon>event</mat-icon>
            </div>
            <h3>{{ 'staff-management.contractual-date' | translate }}</h3>
          </div>
          <div class="card-body">
            <div class="detail-row">
              <div class="calendar-section">
                <label class="section-label">
                  {{ 'staff-management.contract-date' | translate }}
                  <span class="required">*</span>
                </label>

                <mat-calendar
                  [selected]="form.value.contractDate"
                  (selectedChange)="onContractDateSelected($event)"
                  [minDate]="minContractDate">
                </mat-calendar>

                @if (form.value.contractDate) {
                  <div class="selected-date">
                    <mat-icon>event</mat-icon>
                    <span>{{ form.value.contractDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                }

                @if (form.get('contractDate')?.touched && form.get('contractDate')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.contractDate-required' | translate }}</mat-error>
                }
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <div class="calendar-section">
                <label class="section-label">
                  {{ 'staff-management.contract-end-date' | translate }}
                </label>

                <mat-calendar
                  [selected]="form.value.contractEndDate"
                  (selectedChange)="onContractEndDateSelected($event)"
                  [minDate]="minContractDate">
                </mat-calendar>

                @if (form.value.contractEndDate) {
                  <div class="selected-date">
                    <mat-icon>event</mat-icon>
                    <span>{{ form.value.contractEndDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                }
                <mat-hint>{{ 'staff-management.form.optional' | translate }}</mat-hint>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <div class="calendar-section">
                <label class="section-label">
                  {{ 'staff-management.termination-date' | translate }}
                </label>

                <mat-calendar
                  [selected]="form.value.terminationDate"
                  (selectedChange)="onTerminationDateSelected($event)"
                  [minDate]="minContractDate">
                </mat-calendar>

                @if (form.value.terminationDate) {
                  <div class="selected-date">
                    <mat-icon>event</mat-icon>
                    <span>{{ form.value.terminationDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                }
                <mat-hint>{{ 'staff-management.form.optional' | translate }}</mat-hint>
              </div>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Professional Information Section -->
      <div class="section-divider">
        <mat-icon>school</mat-icon>
        <span>{{ 'staff-management.professional-info' | translate }}</span>
      </div>

      <mat-card class="full-width-card">
        <div class="card-header-custom">
          <div class="icon-wrapper professional">
            <mat-icon>workspace_premium</mat-icon>
          </div>
          <h3>{{ 'staff-management.certifications' | translate }}</h3>
        </div>
        <div class="card-body">
          <mat-form-field>
            <mat-label>{{ 'staff-management.certifications' | translate }}</mat-label>
            <mat-chip-grid #chipGrid>
              @for (certification of form.value.certifications; track certification) {
                <mat-chip-row (removed)="removeCertification(certification)">
                  {{ certification }}
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-row>
              }
              <input placeholder="{{ 'staff-management.form.add-certification' | translate }}"
                     [matChipInputFor]="chipGrid"
                     (matChipInputTokenEnd)="addCertification($event)">
            </mat-chip-grid>
            <mat-hint>{{ 'staff-management.form.optional' | translate }}</mat-hint>
          </mat-form-field>
        </div>
      </mat-card>

      <!-- Emergency Contacts Section -->
      <div class="section-divider">
        <mat-icon>emergency</mat-icon>
        <span>{{ 'staff-management.emergency-contacts' | translate }}</span>
      </div>

      <div class="info-grid">
        <mat-card class="info-card">
          <div class="card-header-custom">
            <div class="icon-wrapper emergency">
              <mat-icon>contact_emergency</mat-icon>
            </div>
            <h3>{{ 'staff-management.emergency-contact' | translate }}</h3>
          </div>
          <div class="card-body">
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.emergencyContactName' | translate }}</mat-label>
                <input matInput formControlName="emergencyContactName" required>
                @if (form.get('emergencyContactName')?.touched && form.get('emergencyContactName')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.emergencyContactName-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
            <mat-divider></mat-divider>
            <div class="detail-row">
              <mat-form-field>
                <mat-label>{{ 'staff-management.emergencyContactPhone' | translate }}</mat-label>
                <input matInput formControlName="emergencyContactPhone" required>
                @if (form.get('emergencyContactPhone')?.touched && form.get('emergencyContactPhone')!.hasError('required')) {
                  <mat-error>{{ 'staff-management.error.emergencyContactPhone-required' | translate }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </mat-card>
      </div>

      <div class="space"></div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button mat-raised-button type="button" (click)="onCancel()">
          <mat-icon>cancel</mat-icon>
          {{ 'staff-management.buttons.cancel' | translate }}
        </button>

        <button mat-raised-button color="primary" type="submit">
          <mat-icon>save</mat-icon>
          {{ (isEdit ? 'staff-management.buttons.update' : 'staff-management.buttons.register') | translate }}
        </button>
      </div>

    </form>
  </div>
</app-layout-nursing-home>
