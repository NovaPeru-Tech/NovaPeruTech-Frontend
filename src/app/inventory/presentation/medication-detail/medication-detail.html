<app-layout-nursing-home>
  <h1 class="title">{{ 'Medication Detail' | translate }}</h1>

  <div class="detail-wrapper">
    @if (!medication()) {
      <div class="loading-container">
        <mat-progress-spinner mode="indeterminate" color="primary"></mat-progress-spinner>
        <p>{{ 'medication.loading' | translate }}</p>
      </div>
    } @else {
      <div class="detail-container">
        <div class="top-actions">
          <button mat-raised-button
                  color="accent"
                  (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
            {{ 'residents.buttons.go-back' | translate }}
          </button>
        </div>

        <!-- Header Card -->
        <mat-card class="header-card">
          <div class="header-content">
            <div class="photo-section">
              <div class="photo-wrapper">
                <div class="photo-frame">
                  <img [src]="medication()!.image"
                       (load)="onImageLoad(medication()!.id)"
                       (error)="onImageError($event, medication()!.id)"
                       [alt]="medication()!.name"
                       [class.loaded]="imageLoadedMap[medication()!.id]">
                </div>
              </div>
            </div>

            <div class="main-info">
              <div class="name-section">
                <h1 class="medication-name">
                  {{ medication()!.name }}
                </h1>
              </div>

              <div class="quick-info">
                <div class="info-item">
                  <mat-icon>medication</mat-icon>
                  <div>
                    <span class="info-label">{{ 'Type' | translate }}</span>
                    <span class="info-value">{{ medication()!.type }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>percent</mat-icon>
                  <div>
                    <span class="info-label">{{ 'Concentration' | translate }}</span>
                    <span class="info-value">{{ medication()!.concentration }}</span>
                  </div>
                </div>
                <div class="info-item">
                  <mat-icon>medication_liquid</mat-icon>
                  <div>
                    <span class="info-label">{{ 'Pharmaceutical Form' | translate }}</span>
                    <span class="info-value">{{ medication()!.pharmaceuticalForm }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card>

        <div class="section-divider">
          <mat-icon>inventory</mat-icon>
          <span>{{ 'medication.inventory-info' | translate }}</span>
        </div>

        <div class="info-grid">
          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper personal">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <h3>{{ 'Stock Status' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="stat-body">
                <div class="stat-main-value">
                  <span class="value-number">{{ medication()!.quantity }}</span>
                  <span class="value-unit">{{ medication()!.unit }}</span>
                </div>
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getStockPercentage()">
                      <span class="progress-text">{{ getStockPercentage() | number:'1.0-0' }}%</span>
                    </div>
                  </div>
                </div>
                <div class="stat-meta">
                  <span><mat-icon>trending_down</mat-icon> Min: {{ medication()!.minimumStock }}</span>
                  <span><mat-icon>trending_up</mat-icon> Max: {{ medication()!.maximumStock }}</span>
                </div>
              </div>
            </div>
          </mat-card>

          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper contact">
                <mat-icon>payments</mat-icon>
              </div>
              <h3>{{ 'Total Value' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="stat-main-value">
                <span class="value-currency">S/</span>
                <span
                  class="value-number">{{ (medication()!.quantity * medication()!.unitCost) | number:'1.2-2' }}</span>
              </div>
              <div class="stat-meta cost-breakdown">
                <mat-icon>calculate</mat-icon>
                <span>S/ {{ medication()!.unitCost | number:'1.2-2' }}
                  Ã— {{ medication()!.quantity }} {{ medication()!.unit }}</span>
              </div>
            </div>
          </mat-card>

          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper contact">
                <mat-icon>update</mat-icon>
              </div>
              <h3>{{ 'medication.lastUpdate' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="stat-date large">
                {{ medication()!.lastUpdate | date:'dd/MM/yyyy' }}
              </div>
              <div class="stat-meta">
                <mat-icon>schedule</mat-icon>
                {{ medication()!.lastUpdate | date:'HH:mm' }}
              </div>
            </div>
          </mat-card>
        </div>

        <div class="section-divider">
          <mat-icon>local_shipping</mat-icon>
          <span>{{ 'medication.batch-supplier-info' | translate }}</span>
        </div>

        <div class="info-grid">
          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper personal">
                <mat-icon>local_shipping</mat-icon>
              </div>
              <h3>{{ 'Batch and Supplier' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon>business</mat-icon>
                  {{ 'medication.supplier' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.supplier }}</div>
              </div>
              <mat-divider></mat-divider>
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon>qr_code_2</mat-icon>
                  {{ 'medication.batchNumber' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.batchNumber }}</div>
              </div>
              <mat-divider></mat-divider>
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon>badge</mat-icon>
                  {{ 'medication.registrationNumber' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.registrationNumber }}</div>
              </div>
              <mat-divider></mat-divider>
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"><path d="M40-120v-200h80v120h120v80H40Zm680 0v-80h120v-120h80v200H720ZM160-240v-480h80v480h-80Zm120 0v-480h40v480h-40Zm120 0v-480h80v480h-80Zm120 0v-480h120v480H520Zm160 0v-480h40v480h-40Zm80 0v-480h40v480h-40ZM40-640v-200h200v80H120v120H40Zm800 0v-120H720v-80h200v200h-80Z"/></svg></mat-icon>
                  {{ 'medication.barcode' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.barcode }}</div>
              </div>
            </div>
          </mat-card>

          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper contact">
                <mat-icon>schedule</mat-icon>
              </div>
              <h3>{{ 'Expiration' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="stat-main-value">
                @if (getDaysUntilExpiration() > 0) {
                  <span class="value-number">{{ getDaysUntilExpiration() }}</span>
                  <span class="value-unit">Days</span>
                } @else {
                  <span class="value-expired">Expired</span>
                }
              </div>
              <div class="stat-date">
                <mat-icon>calendar_today</mat-icon>
                {{ medication()!.expirationDate | date:'dd MMM yyyy' }}
              </div>
              <div class="stat-meta">
              <span>
                @if (getDaysUntilExpiration() > 0) {
                  {{ 'medication.days-remaining' | translate }}
                } @else {
                  {{ 'medication.expired' | translate }}
                }
              </span>
              </div>
            </div>
          </mat-card>
        </div>

        <div class="section-divider">
          <mat-icon>warehouse</mat-icon>
          <span>{{ 'medication.storage-info' | translate }}</span>
        </div>

        <div class="info-grid">
          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper personal">
                <mat-icon>warehouse</mat-icon>
              </div>
              <h3>{{ 'Storage' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon>place</mat-icon>
                  {{ 'medication.storageLocation' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.storageLocation }}</div>
              </div>
              @if (medication()!.storageConditions && medication()!.storageConditions.length > 0) {
                <mat-divider></mat-divider>
                <div class="storage-conditions">
                  <span class="conditions-label">{{ 'medication.storageConditions' | translate }}</span>
                  <div class="conditions-list">
                    @for (condition of medication()!.storageConditions; track condition) {
                      <mat-chip class="condition-chip">
                        <mat-icon>check</mat-icon>
                        {{ condition }}
                      </mat-chip>
                    }
                  </div>
                </div>
              }
            </div>
          </mat-card>

          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper contact">
                <mat-icon>verified_user</mat-icon>
              </div>
              <h3>{{ 'Special Requirements' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="requirements-grid">
                <div class="requirement-item" [class.active]="medication()!.requiresRefrigeration">
                  <div class="requirement-icon">
                    <mat-icon>ac_unit</mat-icon>
                  </div>
                  <span>{{ 'medication.requiresRefrigeration' | translate }}</span>
                  <mat-icon
                    class="status-icon">{{ medication()!.requiresRefrigeration ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                </div>
                <div class="requirement-item" [class.active]="medication()!.requiresPrescription">
                  <div class="requirement-icon">
                    <mat-icon>description</mat-icon>
                  </div>
                  <span>{{ 'medication.requiresPrescription' | translate }}</span>
                  <mat-icon class="status-icon">{{ medication()!.requiresPrescription ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                </div>
              </div>
            </div>
          </mat-card>

          <mat-card class="info-card">
            <div class="card-header-custom">
              <div class="icon-wrapper personal">
                <mat-icon>medical_services</mat-icon>
              </div>
              <h3>{{ 'medication.administration' | translate }}</h3>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <div class="detail-label">
                  <mat-icon>route</mat-icon>
                  {{ 'medication.administrationRoute' | translate }}
                </div>
                <div class="detail-value">{{ medication()!.administrationRoute }}</div>
              </div>
            </div>
          </mat-card>
        </div>

        <div class="section-divider">
          <mat-icon>info</mat-icon>
          <span>{{ 'medication.additional-info' | translate }}</span>
        </div>

        <mat-card class="full-width-card">
          <div class="card-header-custom">
            <div class="icon-wrapper professional">
              <mat-icon>warning</mat-icon>
            </div>
            <h3>{{ 'Contraindications' | translate }}</h3>
          </div>
          <div class="card-body">
            @for (contraindication of medication()!.contraindications; track contraindication) {
              <div class="contraindication-item">
                <mat-icon>error_outline</mat-icon>
                <span>{{ contraindication }}</span>
              </div>
            }
          </div>
        </mat-card>

        <div class="spacer"></div>

        <mat-card class="full-width-card">
          <div class="card-header-custom">
            <div class="icon-wrapper professional">
              <mat-icon>info</mat-icon>
            </div>
            <h3>{{ 'Special Notes' | translate }}</h3>
          </div>
          <div class="card-body">
            <p class="notes-text">{{ medication()!.specialNotes }}</p>
          </div>
        </mat-card>

        <div class="space"></div>

        <div class="action-buttons">
          <button mat-raised-button
                  color="accent"
                  (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
            {{ 'Go Back' | translate }}
          </button>

          <button mat-raised-button
                  color="warn"
                  (click)="deleteMedication()">
            <mat-icon>delete</mat-icon>
            {{ 'Delete' | translate }}
          </button>

          <button mat-raised-button
                  color="primary"
                  (click)="editMedication()">
            <mat-icon>edit</mat-icon>
            {{ 'Edit' | translate }}
          </button>
        </div>
      </div>
    }
  </div>
</app-layout-nursing-home>
